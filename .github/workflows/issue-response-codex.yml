name: Codex Issue Response Bot

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  respond-with-codex:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install OpenAI Codex
        run: npm install -g @openai/codex
        
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y
      
      - name: Generate response with Codex
        id: generate_response
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Codexに応答を生成させる
          RESPONSE=$(codex -a auto-edit --quiet "以下のissueまたはコメントに対して適切な返信を作成してください：
          
          イベントタイプ: ${{ github.event_name }}
          アクション: ${{ github.event.action }}
          Issue番号: #${{ github.event.issue.number }}
          タイトル: ${{ github.event.issue.title }}
          内容: ${{ github.event.issue.body }}
          
          コメントの場合:
          コメント内容: ${{ github.event.comment.body }}
          コメント投稿者: ${{ github.event.comment.user.login }}
          
          以下のようなシンプルで丁寧な応答を生成してください。")
          
          # 改行をエスケープして環境変数に保存
          echo "response<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Post response comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Codexが生成した応答をコメントとして投稿
          gh issue comment ${{ github.event.issue.number }} --body "${{ env.response }}"
