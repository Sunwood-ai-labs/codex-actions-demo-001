name: Issue Response Bot (Codex with gh)

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  respond-to-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install OpenAI Codex
        run: npm install -g @openai/codex
        
      - name: GitHub CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          type -p curl >/dev/null || apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y
          
      - name: Post Initial Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å‡¦ç†é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨æŠ˜ã‚ŠãŸãŸã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
          gh issue comment ${{ github.event.issue.number }} --body 'ğŸš€ å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...

          <details>
          <summary>Codexã¸ã®æŒ‡ç¤ºå†…å®¹</summary>

          ```
          ä»¥ä¸‹ã®issueã«å¯¾ã™ã‚‹å¯¾å¿œè¨ˆç”»ã‚’ç«‹ã¦ã€ghã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼š
          
          Issueç•ªå·: #${{ github.event.issue.number }}
          ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}
          å†…å®¹: ${{ github.event.issue.body }}
          
          å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          1. issueã‚’åˆ†æã—ã¦å¯¾å¿œæ–¹é‡ã‚’æ±ºå®š
          2. ghã‚³ãƒãƒ³ãƒ‰ã§è¨ˆç”»ã‚’issueã«ã‚³ãƒ¡ãƒ³ãƒˆ (ä¾‹: gh issue comment #ç•ªå· --body '"'"'å†…å®¹'"'"')
          3. å¿…è¦ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’å®Ÿæ–½
          ```
          </details>'
        
      - name: Analyze and Plan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Codexã«è¨ˆç”»ã‚’ç«‹ã¦ã•ã›ã€issueã«ã‚³ãƒ¡ãƒ³ãƒˆã•ã›ã‚‹
          codex --full-auto  --quiet  "ä»¥ä¸‹ã®issueã«å¯¾ã™ã‚‹å¯¾å¿œè¨ˆç”»ã‚’ç«‹ã¦ã€ghã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼š
          
          Issueç•ªå·: #${{ github.event.issue.number }}
          ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}
          å†…å®¹: ${{ github.event.issue.body }}
          
          å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          1. issueã‚’åˆ†æã—ã¦å¯¾å¿œæ–¹é‡ã‚’æ±ºå®š
          2. ghã‚³ãƒãƒ³ãƒ‰ã§è¨ˆç”»ã‚’issueã«ã‚³ãƒ¡ãƒ³ãƒˆ (ä¾‹: gh issue comment #ç•ªå· --body 'å†…å®¹')
          3. å¿…è¦ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’å®Ÿæ–½"
          
      - name: Create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ (YYYYMMDDHHmmsså½¢å¼)
          TIMESTAMP=$(date '+%Y%m%d%H%M%S')
          BRANCH_NAME="fix-issue-${{ github.event.issue.number }}-$TIMESTAMP"
          
          # ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
          git status
          
          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b $BRANCH_NAME
          
          # ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆå¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
          git status
          
          # CodexãŒä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’å…¨ã¦è¿½åŠ 
          git add .
          
          # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
          git status
          
          # Codexã«ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã•ã›ã‚‹
          codex --full-auto --quiet $'ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
      
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          git status
      
          # é©åˆ‡ãªã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          # Issueç•ªå·ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‚ç…§ã—ã€å¤‰æ›´ã®ç¨®é¡ã«å¿œã˜ã¦å†…å®¹ã‚’èª¿æ•´ã—ã¦ãã ã•ã„
          git commit -m "ğŸ”§ fix: #${{ github.event.issue.number }} ${{ github.event.issue.title }}" -m "ğŸ” å•é¡Œ: ${{ github.event.issue.body }}" -m "âœ… å¯¾å¿œ: å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ãƒ»ä¿®æ­£ã—ã¾ã—ãŸ" -m "Issue: #${{ github.event.issue.number }}"
          
          # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥
          git push origin HEAD:$BRANCH_NAME
          
          # PRã‚’ä½œæˆ - å†…å®¹ã¯Issueã®å†…å®¹ã¨å¤‰æ›´ã«åˆã‚ã›ã¦é©åˆ‡ã«è¨˜è¿°ã—ã¦ãã ã•ã„
          gh pr create \
            --title "âœ¨ fix: #${{ github.event.issue.number }} ${{ github.event.issue.title }}" \
            --body $\'## ğŸš€ å¯¾å¿œå†…å®¹\n${{ github.event.issue.body }}\n\n### ğŸ” å•é¡Œã¨è§£æ±ºç­–\nIssueã®å†…å®¹ã«åŸºã¥ã„ã¦é©åˆ‡ãªå¯¾å¿œã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚\n\n### ğŸ“ å¤‰æ›´å†…å®¹\n- å¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨ãã®å†…å®¹ã®èª¬æ˜\n\n### ğŸ§ª ãƒ†ã‚¹ãƒˆå†…å®¹\n- å‹•ä½œç¢ºèªæ–¹æ³•ã¨çµæœ\n\nFixes #${{ github.event.issue.number }}\' \
            --base main \
            --head $BRANCH_NAME
          
          # PRã®URLã‚’å–å¾—
          PR_URL=$(gh pr view --json url -q .url)
          
          # Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
          gh issue comment ${{ github.event.issue.number }} --body $\'ğŸ‰ PRä½œæˆå®Œäº†ã—ã¾ã—ãŸï¼\n\nğŸ‘€ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™\nğŸ”— PR: \' + PR_URL + $\'\n\n### ğŸ“‹ å¯¾å¿œæ¦‚è¦\n${{ github.event.issue.title }}ã«å¯¾å¿œã™ã‚‹PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼\'
          '
